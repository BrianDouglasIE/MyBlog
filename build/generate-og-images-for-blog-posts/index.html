<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

    <!-- Meta Description -->
    <meta name="description" content="Generate OG images for blog posts"/>

    <!-- Keywords -->
    <meta name="keywords" content="Brian Douglas, blog, node,js"/>

    <!-- Author -->
    <meta name="author" content="Brian Douglas"/>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="BrianDouglas.ie - Generate OG images for blog posts"/>
    <meta property="og:description" content="Generate OG images for blog posts"/>
    <meta property="og:url" content="https://www.briandouglas.ie"/>
    <meta property="og:image" content="http://www.briandouglas.ie/images/og-images/generate-og-images-for-blog-posts.png"/>
    <meta property="og:image:type" content="image/png"/>
    <meta property="og:image:width" content="1280"/>
    <meta property="og:image:height" content="640"/>
    <meta property="og:site_name" content="BrianDouglas.ie"/>
    <meta property="og:image:alt" content="A preview image for the post titled 'Generate OG images for blog posts'"/>

    <!-- Twitter Meta -->
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:site" content="@BrianDouglasIE"/>
    <meta name="twitter:title" content="BrianDouglas.ie - Generate OG images for blog posts"/>
    <meta name="twitter:description" content="Generate OG images for blog posts"/>
    <meta name="twitter:image" content="http://www.briandouglas.ie/images/og-images/generate-og-images-for-blog-posts.png"/>

    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.briandouglas.ie"/>

    <!-- Favicon (Optional) -->
    <link rel="icon" href="https://www.briandouglas.ie/favicon.ico" type="image/x-icon"/>

    <!-- Robots -->
    <meta name="robots" content="index, follow"/>

    <!-- Favicon-->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/>
    <link rel="manifest" href="/site.webmanifest"/>

    <title>Generate OG images for blog posts</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#24292e;background:#ffffff}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#d73a49}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#6f42c1}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-variable{color:#005cc5}.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#032f62}.hljs-built_in,.hljs-symbol{color:#e36209}.hljs-code,.hljs-comment,.hljs-formula{color:#6a737d}.hljs-name,.hljs-quote,.hljs-selector-pseudo,.hljs-selector-tag{color:#22863a}.hljs-subst{color:#24292e}.hljs-section{color:#005cc5;font-weight:bold}.hljs-bullet{color:#735c0f}.hljs-emphasis{color:#24292e;font-style:italic}.hljs-strong{color:#24292e;font-weight:bold}.hljs-addition{color:#22863a;background-color:#f0fff4}.hljs-deletion{color:#b31d28;background-color:#ffeef0}.hljs-char.escape_,.hljs-link,.hljs-params,.hljs-property,.hljs-punctuation,.hljs-tag{}
    </style>
</head>
<body>

<div class="content">
    <header class="site-header">
    <a href="/" class="home">Brian Douglas</a>

    <div class="svg-container">
        <a href="https://github.com/BrianDouglasIE" class="github">
            <svg
                height="32"
                aria-hidden="true"
                viewBox="0 0 24 24"
                width="32"
                data-view-component="true"
            >
                <path
                    d="M12.5.75C6.146.75 1 5.896 1 12.25c0 5.089 3.292 9.387 7.863 10.91.575.101.79-.244.79-.546 0-.273-.014-1.178-.014-2.142-2.889.532-3.636-.704-3.866-1.35-.13-.331-.69-1.352-1.18-1.625-.402-.216-.977-.748-.014-.762.906-.014 1.553.834 1.769 1.179 1.035 1.74 2.688 1.25 3.349.948.1-.747.402-1.25.733-1.538-2.559-.287-5.232-1.279-5.232-5.678 0-1.25.445-2.285 1.178-3.09-.115-.288-.517-1.467.115-3.048 0 0 .963-.302 3.163 1.179.92-.259 1.897-.388 2.875-.388.977 0 1.955.13 2.875.388 2.2-1.495 3.162-1.179 3.162-1.179.633 1.581.23 2.76.115 3.048.733.805 1.179 1.825 1.179 3.09 0 4.413-2.688 5.39-5.247 5.678.417.36.776 1.05.776 2.128 0 1.538-.014 2.774-.014 3.162 0 .302.216.662.79.547C20.709 21.637 24 17.324 24 12.25 24 5.896 18.854.75 12.5.75Z"
                ></path>
            </svg>
        </a>

        <a
            href="https://linkedin.com/in/brian-douglas-90abb93ab"
            class="linkedin"
        >
            <svg
                viewBox="0 0 128 128"
                height="32"
                aria-hidden="true"
                width="32"
                data-view-component="true"
            >
                <path
                    d="M116 3H12a8.91 8.91 0 00-9 8.8v104.42a8.91 8.91 0 009 8.78h104a8.93 8.93 0 009-8.81V11.77A8.93 8.93 0 00116 3zM39.17 107H21.06V48.73h18.11zm-9-66.21a10.5 10.5 0 1110.49-10.5 10.5 10.5 0 01-10.54 10.48zM107 107H88.89V78.65c0-6.75-.12-15.44-9.41-15.44s-10.87 7.36-10.87 15V107H50.53V48.73h17.36v8h.24c2.42-4.58 8.32-9.41 17.13-9.41C103.6 47.28 107 59.35 107 75z"
                ></path>
            </svg>
        </a>
    </div>
</header>

    <div class="breadcrumbs">
        <a href="/">Home</a> / <span>Generate OG images for blog posts</span>
    </div>

    <main>
        <article class="post">
            <header>
                <h1>Generate OG images for blog posts</h1>
                <time datetime="07/09/2024">September 7th, 2024</time>
            </header>

            <div class="body">
                <p>When sharing an article on social media you will see a preview. The preview uses the html <code>og:image</code> meta tag. In this
article I will demonstrate how I generate a unique <code>og:image</code> for each of my blog posts.</p>
<!-- more -->
<p>The general gist here is that we want to create a method that will take the title of our post and generate an image
with that title text. We will use a template image to place the text into. The template image I use is shown below.
Note the empty space on the right hand side, this is where we will place our blog post title. As recommended by github
I have also left and 80px margin around the content. The dimensions of the image are 1280x640 pixels.</p>
<p><img class="pure-img" src="/images/open-graph-template.png"  alt="my og:image template"/></p>
<h2 id="theimplementation">The Implementation</h2>
<p>In order to write the title of our blog post to the template image we will use the npm package <a href="https://www.npmjs.com/package/pureimage">PureImage</a>.
This package allows us to use the canvas api to draw to a context which we can then export as an image, without loading
up a browser instance.</p>
<p><magpie-trinket>
He probably leaves out a load of detail in the next section. But the general gist is as follows.</p>
<ul>
    <li>Create a template image that you want to write too</li>
    <li>Install the PureImage package</li>
    <li>Load the desired font intro PureImage</li>
    <li>Draw the text on to the template image using a PureImage context</li>
    <li>Output the new image to the desired location</li>
</ul>
<p></magpie-trinket></p>
<h3 id="gotcha1loadingthefont">Gotcha 1 - Loading the font</h3>
<p>The first gotcha when using <code>PureImage</code> is that there are no fonts loaded by default. So in order to draw text to our image
we must first load the font like so.</p>
<pre class="javascript language-javascript"><code class="hljs javascript language-javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">PImage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;pureimage&quot;</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OUT_DIR</span> = <span class="hljs-string">&quot;./docs/images/og-images&quot;</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FONT</span> = <span class="hljs-title class_">PImage</span>.<span class="hljs-title function_">registerFont</span>(
  <span class="hljs-string">&quot;C:\\Users\\brian\\AppData\\Local\\Microsoft\\Windows\\Fonts\\JetBrainsMono-Bold.ttf&quot;</span>,
  <span class="hljs-string">&quot;MyFont&quot;</span>,
);

<span class="hljs-variable constant_">FONT</span>.<span class="hljs-title function_">loadSync</span>();
</code></pre>
<p>This will load the required font so that we can use it when drawing on our image template.</p>
<h3 id="gotcha2wrappingthetext">Gotcha 2 - Wrapping the text</h3>
<p>The second gotcha is that because we are using the canvas api to draw text, it will not wrap unless we specifically tell
it to do so. To get around this I have used the below method. This is actually a common issue when making browser games
using the canvas. So I was expecting to encounter the problem.</p>
<pre class="javascript language-javascript"><code class="hljs javascript language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">wrapText</span>(<span class="hljs-params">ctx, text, x, y, maxWidth, lineHeight</span>) {
  <span class="hljs-keyword">const</span> words = text.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot; &quot;</span>);
  <span class="hljs-keyword">let</span> line = <span class="hljs-string">&quot;&quot;</span>;
  <span class="hljs-keyword">let</span> testLine, metrics, testWidth;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> n = <span class="hljs-number">0</span>; n &lt; words.<span class="hljs-property">length</span>; n++) {
    testLine = line + words[n] + <span class="hljs-string">&quot; &quot;</span>;
    metrics = ctx.<span class="hljs-title function_">measureText</span>(testLine);
    testWidth = metrics.<span class="hljs-property">width</span>;

    <span class="hljs-keyword">if</span> (testWidth &gt; maxWidth &amp;&amp; n &gt; <span class="hljs-number">0</span>) {
      ctx.<span class="hljs-title function_">fillText</span>(line, x, y);
      line = words[n] + <span class="hljs-string">&quot; &quot;</span>;
      y += lineHeight;
    } <span class="hljs-keyword">else</span> {
      line = testLine;
    }
  }
  ctx.<span class="hljs-title function_">fillText</span>(line, x, y);
}
</code></pre>
<h3 id="puttingitalltogether">Putting it all together</h3>
<p>Here is the code I use to generate my OG images. It's specific to my use case, but I feel that you, a talented software
engineer, will be able to extract the bits you need.</p>
<p>The main domain specific things here is that my <code>Post</code> class looks something like this.</p>
<pre class="typescript language-typescript"><code class="hljs typescript language-typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Post</span> = {
    <span class="hljs-attr">slug</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">html</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">excerpt</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">date</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">tags</span>: <span class="hljs-built_in">string</span>[] }
}
</code></pre>
<p>With that in mind here is the full implementation.</p>
<pre class="javascript language-javascript"><code class="hljs javascript language-javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">PImage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;pureimage&quot;</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;fs&quot;</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;node:path&quot;</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OUT_DIR</span> = <span class="hljs-string">&quot;./docs/images/og-images&quot;</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FONT</span> = <span class="hljs-title class_">PImage</span>.<span class="hljs-title function_">registerFont</span>(
  <span class="hljs-string">&quot;C:\\Users\\brian\\AppData\\Local\\Microsoft\\Windows\\Fonts\\JetBrainsMono-Bold.ttf&quot;</span>,
  <span class="hljs-string">&quot;MyFont&quot;</span>,
);

<span class="hljs-variable constant_">FONT</span>.<span class="hljs-title function_">loadSync</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateOGImage</span>(<span class="hljs-params">post</span>) {
  <span class="hljs-keyword">const</span> pImage = <span class="hljs-title class_">PImage</span>.<span class="hljs-title function_">make</span>(<span class="hljs-number">1280</span>, <span class="hljs-number">640</span>);
  <span class="hljs-keyword">const</span> ctx = pImage.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;2d&quot;</span>);
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PImage</span>.<span class="hljs-title function_">decodePNGFromStream</span>(
    fs.<span class="hljs-title function_">createReadStream</span>(<span class="hljs-string">&quot;./theme/assets/images/open-graph-template.png&quot;</span>),
  );
  ctx.<span class="hljs-title function_">drawImage</span>(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> text = post.<span class="hljs-property">data</span>.<span class="hljs-property">title</span>;
  <span class="hljs-keyword">const</span> maxWidth = <span class="hljs-number">700</span>;
  <span class="hljs-keyword">const</span> lineHeight = <span class="hljs-number">80</span>;
  <span class="hljs-keyword">const</span> x = <span class="hljs-number">520</span>;
  <span class="hljs-keyword">const</span> y = <span class="hljs-number">270</span>;

  ctx.<span class="hljs-property">font</span> = <span class="hljs-string">&quot;80px MyFont&quot;</span>;
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&quot;black&quot;</span>;
  <span class="hljs-title function_">wrapText</span>(ctx, text, x, y, maxWidth, lineHeight);

  <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(<span class="hljs-variable constant_">OUT_DIR</span>)) {
    fs.<span class="hljs-title function_">mkdirSync</span>(<span class="hljs-variable constant_">OUT_DIR</span>);
  }

  <span class="hljs-keyword">await</span> <span class="hljs-title class_">PImage</span>.<span class="hljs-title function_">encodePNGToStream</span>(
    pImage,
    fs.<span class="hljs-title function_">createWriteStream</span>(path.<span class="hljs-title function_">join</span>(<span class="hljs-variable constant_">OUT_DIR</span>, <span class="hljs-string">`<span class="hljs-subst">${post.slug}</span>.png`</span>)),
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">wrapText</span>(<span class="hljs-params">ctx, text, x, y, maxWidth, lineHeight</span>) {
  <span class="hljs-keyword">const</span> words = text.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot; &quot;</span>);
  <span class="hljs-keyword">let</span> line = <span class="hljs-string">&quot;&quot;</span>;
  <span class="hljs-keyword">let</span> testLine, metrics, testWidth;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> n = <span class="hljs-number">0</span>; n &lt; words.<span class="hljs-property">length</span>; n++) {
    testLine = line + words[n] + <span class="hljs-string">&quot; &quot;</span>;
    metrics = ctx.<span class="hljs-title function_">measureText</span>(testLine);
    testWidth = metrics.<span class="hljs-property">width</span>;

    <span class="hljs-keyword">if</span> (testWidth &gt; maxWidth &amp;&amp; n &gt; <span class="hljs-number">0</span>) {
      ctx.<span class="hljs-title function_">fillText</span>(line, x, y);
      line = words[n] + <span class="hljs-string">&quot; &quot;</span>;
      y += lineHeight;
    } <span class="hljs-keyword">else</span> {
      line = testLine;
    }
  }
  ctx.<span class="hljs-title function_">fillText</span>(line, x, y);
}
</code></pre>
<h2 id="theresult">The Result</h2>
<p>Now we can call <code>generateOGImage(myPost)</code> and it will generate a unique og image for the supplied post. The supplied
post's title will be drawn on the image. Using this code on the blog post you are currently reading will generate the
below image.</p>
<p><img class="pure-img" src="/images/og-images/generate-og-images-for-blog-posts.png"  alt="the og:image for this blog"/></p>
<p>Unfortunately as you can see from the image, the library we used (<code>PureImage</code>) isn't great at rendering fonts. So the font 
looks a little choppy. Potentially a different library would do a better job. Alternatively we could use a tool like 
webdriver.io or selenium to render the template as html and save it as an image which may yield better results. For me
however, the current implementation will suffice.</p>
            </div>

            <footer>
                <p><i>Until next time,</i></p>
                <p><i>Brian</i></p>
            </footer>
        </article>
    </main>

    <footer class="site-footer">
    <p>
        <small>Since August 4th, 2023. All words by Brian
            Douglas. <a href="mailto:brianwdouglas@proton.me">Have a comment?</a></small>
    </p>
</footer>

</div>

<script src="/scripts/chicken-and-magpie.js"></script>
<script src="/scripts/skip-to-section.js"></script>
</body>
</html>
