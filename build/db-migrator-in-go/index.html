<!doctype html>
<html lang="en">
    <head>
        <!-- Google tag (gtag.js) -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-SXTREFVFLB"
        ></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", "G-SXTREFVFLB");
        </script>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- Meta Description -->
        <meta name="description" content="Writing a DB migrator in Go" />

        <!-- Keywords -->
        <meta
            name="keywords"
            content="Brian Douglas, blog, go"
        />

        <!-- Author -->
        <meta name="author" content="Brian Douglas" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta
            property="og:title"
            content="BrianDouglas.ie - Writing a DB migrator in Go"
        />
        <meta property="og:description" content="Writing a DB migrator in Go" />
        <meta property="og:url" content="https://www.briandouglas.ie" />
        <meta
            property="og:image"
            content="http://www.briandouglas.ie/images/og-images/db-migrator-in-go.png"
        />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="1280" />
        <meta property="og:image:height" content="640" />
        <meta property="og:site_name" content="BrianDouglas.ie" />
        <meta
            property="og:image:alt"
            content="A preview image for the post titled 'Writing a DB migrator in Go'"
        />

        <!-- Twitter Meta -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@BrianDouglasIE" />
        <meta
            name="twitter:title"
            content="BrianDouglas.ie - Writing a DB migrator in Go"
        />
        <meta name="twitter:description" content="Writing a DB migrator in Go" />
        <meta
            name="twitter:image"
            content="http://www.briandouglas.ie/images/og-images/db-migrator-in-go.png"
        />

        <!-- Canonical URL -->
        <link rel="canonical" href="https://www.briandouglas.ie" />

        <!-- Favicon (Optional) -->
        <link
            rel="icon"
            href="https://www.briandouglas.ie/favicon.ico"
            type="image/x-icon"
        />

        <!-- Robots -->
        <meta name="robots" content="index, follow" />

        <!-- Favicon-->
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/favicon-16x16.png"
        />
        <link rel="manifest" href="/site.webmanifest" />

        <title>Writing a DB migrator in Go</title>
        <link rel="stylesheet" href="/styles.css" />
        <style>
            pre code.hljs {
                display: block;
                overflow-x: auto;
                padding: 1em;
            }
            code.hljs {
                padding: 3px 5px;
            }
            .hljs {
                color: #24292e;
                background: #ffffff;
            }
            .hljs-doctag,
            .hljs-keyword,
            .hljs-meta .hljs-keyword,
            .hljs-template-tag,
            .hljs-template-variable,
            .hljs-type,
            .hljs-variable.language_ {
                color: #d73a49;
            }
            .hljs-title,
            .hljs-title.class_,
            .hljs-title.class_.inherited__,
            .hljs-title.function_ {
                color: #6f42c1;
            }
            .hljs-attr,
            .hljs-attribute,
            .hljs-literal,
            .hljs-meta,
            .hljs-number,
            .hljs-operator,
            .hljs-selector-attr,
            .hljs-selector-class,
            .hljs-selector-id,
            .hljs-variable {
                color: #005cc5;
            }
            .hljs-meta .hljs-string,
            .hljs-regexp,
            .hljs-string {
                color: #032f62;
            }
            .hljs-built_in,
            .hljs-symbol {
                color: #e36209;
            }
            .hljs-code,
            .hljs-comment,
            .hljs-formula {
                color: #6a737d;
            }
            .hljs-name,
            .hljs-quote,
            .hljs-selector-pseudo,
            .hljs-selector-tag {
                color: #22863a;
            }
            .hljs-subst {
                color: #24292e;
            }
            .hljs-section {
                color: #005cc5;
                font-weight: bold;
            }
            .hljs-bullet {
                color: #735c0f;
            }
            .hljs-emphasis {
                color: #24292e;
                font-style: italic;
            }
            .hljs-strong {
                color: #24292e;
                font-weight: bold;
            }
            .hljs-addition {
                color: #22863a;
                background-color: #f0fff4;
            }
            .hljs-deletion {
                color: #b31d28;
                background-color: #ffeef0;
            }
            .hljs-char.escape_,
            .hljs-link,
            .hljs-params,
            .hljs-property,
            .hljs-punctuation,
            .hljs-tag {
            }
        </style>
    </head>
    <body>
        <div class="content">
            <header class="site-header">
    <a href="/" class="home">Brian Douglas</a>

    <div class="svg-container">
        <a href="https://github.com/BrianDouglasIE" class="github">
            <svg
                height="32"
                aria-hidden="true"
                viewBox="0 0 24 24"
                width="32"
                data-view-component="true"
            >
                <path
                    d="M12.5.75C6.146.75 1 5.896 1 12.25c0 5.089 3.292 9.387 7.863 10.91.575.101.79-.244.79-.546 0-.273-.014-1.178-.014-2.142-2.889.532-3.636-.704-3.866-1.35-.13-.331-.69-1.352-1.18-1.625-.402-.216-.977-.748-.014-.762.906-.014 1.553.834 1.769 1.179 1.035 1.74 2.688 1.25 3.349.948.1-.747.402-1.25.733-1.538-2.559-.287-5.232-1.279-5.232-5.678 0-1.25.445-2.285 1.178-3.09-.115-.288-.517-1.467.115-3.048 0 0 .963-.302 3.163 1.179.92-.259 1.897-.388 2.875-.388.977 0 1.955.13 2.875.388 2.2-1.495 3.162-1.179 3.162-1.179.633 1.581.23 2.76.115 3.048.733.805 1.179 1.825 1.179 3.09 0 4.413-2.688 5.39-5.247 5.678.417.36.776 1.05.776 2.128 0 1.538-.014 2.774-.014 3.162 0 .302.216.662.79.547C20.709 21.637 24 17.324 24 12.25 24 5.896 18.854.75 12.5.75Z"
                ></path>
            </svg>
        </a>

        <a
            href="https://linkedin.com/in/brian-douglas-90abb93ab"
            class="linkedin"
        >
            <svg
                viewBox="0 0 128 128"
                height="32"
                aria-hidden="true"
                width="32"
                data-view-component="true"
            >
                <path
                    d="M116 3H12a8.91 8.91 0 00-9 8.8v104.42a8.91 8.91 0 009 8.78h104a8.93 8.93 0 009-8.81V11.77A8.93 8.93 0 00116 3zM39.17 107H21.06V48.73h18.11zm-9-66.21a10.5 10.5 0 1110.49-10.5 10.5 10.5 0 01-10.54 10.48zM107 107H88.89V78.65c0-6.75-.12-15.44-9.41-15.44s-10.87 7.36-10.87 15V107H50.53V48.73h17.36v8h.24c2.42-4.58 8.32-9.41 17.13-9.41C103.6 47.28 107 59.35 107 75z"
                ></path>
            </svg>
        </a>
    </div>
</header>

            <div class="breadcrumbs">
                <a href="/">Home</a> / <span>Writing a DB migrator in Go</span>
            </div>

            <main>
                <article class="post">
                    <header>
                        <h1>Writing a DB migrator in Go</h1>
                        <time datetime="30/09/2024"
                            >September 30th, 2024</time
                        >
                    </header>

                    <div class="body"><p>A database migrator applies database migrations. These are usually SQL scripts that
update the version of a database. They can be applied and reverted. Allowing for db
versions to be rolled back and pushed forward.</p>
<!-- more -->
<p>I feel that these should be simple tools, with simple commands. Migrate up a version, 
migrate down a version, migrate to version x, migrate all pending migrations, and also
a reset command to remove all migrations. This is all I want. So I decided to make my
own, no bloat, no complexity, just simple useful commands.</p>
<p>Convert the above requirements to CLI commands and we get.</p>
<pre><code class="hljs">  -<span class="hljs-keyword">all</span>
        Apply <span class="hljs-keyword">all</span> pending migrations
  -down <span class="hljs-keyword">int</span>
        Migrate down <span class="hljs-keyword">a</span> certain <span class="hljs-keyword">number</span> of versions
  -reset
        Revert <span class="hljs-keyword">all</span> migrations
  -<span class="hljs-keyword">to</span> <span class="hljs-keyword">int</span>
        Migrate <span class="hljs-keyword">to</span> <span class="hljs-keyword">a</span> specific <span class="hljs-keyword">version</span>
  -<span class="hljs-keyword">up</span> <span class="hljs-keyword">int</span>
        Migrate <span class="hljs-keyword">up</span> <span class="hljs-keyword">a</span> certain <span class="hljs-keyword">number</span> of versions
</code></pre>
<p><magpie-trinket>
He highlights some interesting bit's of code below. Well at least the parts he found interesting. If you want the full source code it
is available at <a href="https://github.com/BrianDouglasIE/go-lang-db-migrator">BrianDouglasIE/go-lang-db-migrator</a>.
</magpie-trinket></p>
<h2 id="assumptions">Assumptions</h2>
<p>Let's assume the code in the sections below is part of a package called <code>migrator</code>, and that we will be
running the code from that package as a command line application. Let's also assume that the program has
recieved details about how to connect to the database, and uses the go <code>sql</code> package to connect.</p>
<h2 id="commandlineoptions">Command line options</h2>
<p>This is intended to be a command line tool. Luckily Go's <code>flags</code> package makes this trivial.
I start by defining an <code>Options</code> struct in the <code>migrator</code> package.</p>
<pre class="go language-go"><code class="hljs go language-go"><span class="hljs-keyword">type</span> Options <span class="hljs-keyword">struct</span> {
    To    <span class="hljs-type">int</span>
    Up    <span class="hljs-type">int</span>
    Down  <span class="hljs-type">int</span>
    All   <span class="hljs-type">bool</span>
    Reset <span class="hljs-type">bool</span>
}
</code></pre>
<p>Then inside <code>main.go</code> I can set the <code>Options</code> values like so. Notice the default values and description text.
All this info will be displayed when passing the <code>--help</code> flag.</p>
<pre class="go language-go"><code class="hljs go language-go"><span class="hljs-keyword">var</span> opts migrator.Options
flag.BoolVar(&amp;opts.All, <span class="hljs-string">&quot;all&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;Apply all pending migrations&quot;</span>)
flag.BoolVar(&amp;opts.Reset, <span class="hljs-string">&quot;reset&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;Revert all migrations&quot;</span>)
flag.IntVar(&amp;opts.To, <span class="hljs-string">&quot;to&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;Migrate to a specific version&quot;</span>)
flag.IntVar(&amp;opts.Up, <span class="hljs-string">&quot;up&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;Migrate up a certain number of versions&quot;</span>)
flag.IntVar(&amp;opts.Down, <span class="hljs-string">&quot;down&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;Migrate down a certain number of versions&quot;</span>)
flag.Parse()
</code></pre>
<p>A pointer to this struct will then be passed into the <code>migrator.Migrate</code> function.</p>
<h2 id="structuringamigration">Structuring a migration</h2>
<p>Typically a migration has an <code>up</code> and a <code>down</code> action. I've opted to use sql files for migrations
rather than an orm. I've done this to avoid complexity. The complexity being, having to learn the
nuances of an orm, when I already know what I want to achieve with sql.</p>
<p>The migrations will be stored in a <code>migrations</code> directory and each migration will have a <code>.up.sql</code>
and <code>.down.sql</code> file. The file naming convention will look like this <code>[version]-[name].[direction].sql</code>.
So, for example, our first migration will look as follows. <strong>Note</strong>: this migration will always need to
be first as it creates the table where our migration info will be stored.</p>
<pre class="sql language-sql"><code class="hljs sql language-sql"><span class="hljs-comment">-- 001-create-migrations-table.up.sql</span>
<span class="hljs-keyword">CREATE TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> migrations (
    id <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">PRIMARY KEY</span> AUTOINCREMENT,

    version <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">NOT NULL</span>,
    name TEXT <span class="hljs-keyword">NOT NULL</span>,

    created_at DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 001-create-migrations-table.down.sql</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> migrations;
</code></pre>
<p>Our migrator program will read the <code>migrations</code> directory and gather the migration files into the
following <code>struct</code>.</p>
<pre class="go language-go"><code class="hljs go language-go"><span class="hljs-keyword">type</span> Migration <span class="hljs-keyword">struct</span> {
    Version  <span class="hljs-type">int</span>
    Name     <span class="hljs-type">string</span>
    UpFile   <span class="hljs-type">string</span>
    DownFile <span class="hljs-type">string</span>
}
</code></pre>
<p>This can then be used to sort migrations by version. Getting the latest migration from our <code>migrations</code>
table will tell us our current DB version. When running the <code>up</code> or <code>down</code> commands we need only concern
ourselves with the migrations that have a version that is higher or lower than the current db version 
respectively. If a migration should be applied then execute the <code>UpFile</code> if it should be reverted then
execute the <code>DownFile</code>.</p>
<h2 id="usingtransactionswithcontext">Using transactions with context</h2>
<p>Transactions in go can be used to commit or rollback multiple grouped sql queries.
The go docs at <a href="https://go.dev/doc/database/execute-transactions">database/execute-transactions</a> sum up 
transactions like so.</p>
<blockquote>
  <p>A database transaction groups multiple operations as part of a larger goal.</p>
</blockquote>
<p>The migrator program is doing just that. It takes a bunch of sql statements and runs them to create a 
new database state. Should one of the migrations fail, we can use the go transaction to rollback the
state of the database to how it was before the migrator ran. Alternatively we can also commit the transaction
if all migrations run successfully.</p>
<p>We'll use the transaction along with a context. Using a Go <code>context.Context</code> with a database transaction helps 
manage timeouts, cancellations, and ensures that long-running database operations are cleaned up with the context.
If the context is canceled any ongoing database transactions can be rolled back. This prevents partial data writes
or inconsistencies.</p>
<p>Using a transaction along with a context is trivial.</p>
<pre class="go language-go"><code class="hljs go language-go"><span class="hljs-comment">// create context</span>
ctx := context.Background()

<span class="hljs-comment">// pass our context to the transaction</span>
tx, err := db.BeginTx(ctx, <span class="hljs-literal">nil</span>)
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> fail(err)
}

<span class="hljs-comment">// defer rollback, will be called if `tx.Commit` is not</span>
<span class="hljs-keyword">defer</span> tx.Rollback()
</code></pre>
<p>This transaction can then be passed around out migrator program. Once all the migrations
have been handled, and assuming no errors have occured, the transaction can be committed
be calling <code>tx.Commit</code>. Any call to the trnasaction after it is commited will result in
an error. Commiting ends the transaction.</p>
<h2 id="finalthoughts">Final thoughts</h2>
<p>A db migrator should not be a complex program and it should not have a complex API. I looked
at some widely used libraries for managing migrations and I was struck by their complexity
and learning curve. Due to this I decided it better to create a simple package to achieve the
same end. It took around 90 minutes and helped me to better understand how migrations work. I
also now have my own tool to manage migrations, that I can bend to my liking.</p>
<p>Feel free to look through the entire source code at <a href="https://github.com/BrianDouglasIE/go-lang-db-migrator">BrianDouglasIE/go-lang-db-migrator</a>.</p></div>

                    <footer>
                        <p><i>Until next time,</i></p>
                        <p><i>Brian</i></p>
                    </footer>
                </article>
            </main>

            <footer class="site-footer">
    <p>
        <small>Since August 4th, 2023. All words by Brian
            Douglas. <a href="mailto:brianwdouglas@proton.me">Have a comment?</a></small>
    </p>
</footer>

        </div>

        <script src="/scripts/chicken-and-magpie.js"></script>
        <script src="/scripts/skip-to-section.js"></script>
    </body>
</html>
