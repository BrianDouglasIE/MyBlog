<!doctype html>
<html lang="en">
    <head>
        <!-- Google tag (gtag.js) -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-SXTREFVFLB"
        ></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", "G-SXTREFVFLB");
        </script>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- Meta Description -->
        <meta name="description" content="Use an index when sorting" />

        <!-- Keywords -->
        <meta
            name="keywords"
            content="Brian Douglas, blog, sql"
        />

        <!-- Author -->
        <meta name="author" content="Brian Douglas" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta
            property="og:title"
            content="BrianDouglas.ie - Use an index when sorting"
        />
        <meta property="og:description" content="Use an index when sorting" />
        <meta property="og:url" content="https://www.briandouglas.ie" />
        <meta
            property="og:image"
            content="http://www.briandouglas.ie/images/og-images/use-an-index-when-sorting.png"
        />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="1280" />
        <meta property="og:image:height" content="640" />
        <meta property="og:site_name" content="BrianDouglas.ie" />
        <meta
            property="og:image:alt"
            content="A preview image for the post titled 'Use an index when sorting'"
        />

        <!-- Twitter Meta -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@BrianDouglasIE" />
        <meta
            name="twitter:title"
            content="BrianDouglas.ie - Use an index when sorting"
        />
        <meta name="twitter:description" content="Use an index when sorting" />
        <meta
            name="twitter:image"
            content="http://www.briandouglas.ie/images/og-images/use-an-index-when-sorting.png"
        />

        <!-- Canonical URL -->
        <link rel="canonical" href="https://www.briandouglas.ie" />

        <!-- Favicon (Optional) -->
        <link
            rel="icon"
            href="https://www.briandouglas.ie/favicon.ico"
            type="image/x-icon"
        />

        <!-- Robots -->
        <meta name="robots" content="index, follow" />

        <!-- Favicon-->
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/favicon-16x16.png"
        />
        <link rel="manifest" href="/site.webmanifest" />

        <title>Use an index when sorting</title>
        <link rel="stylesheet" href="/styles.css" />
        <style>
            pre code.hljs {
                display: block;
                overflow-x: auto;
                padding: 1em;
            }
            code.hljs {
                padding: 3px 5px;
            }
            .hljs {
                color: #24292e;
                background: #ffffff;
            }
            .hljs-doctag,
            .hljs-keyword,
            .hljs-meta .hljs-keyword,
            .hljs-template-tag,
            .hljs-template-variable,
            .hljs-type,
            .hljs-variable.language_ {
                color: #d73a49;
            }
            .hljs-title,
            .hljs-title.class_,
            .hljs-title.class_.inherited__,
            .hljs-title.function_ {
                color: #6f42c1;
            }
            .hljs-attr,
            .hljs-attribute,
            .hljs-literal,
            .hljs-meta,
            .hljs-number,
            .hljs-operator,
            .hljs-selector-attr,
            .hljs-selector-class,
            .hljs-selector-id,
            .hljs-variable {
                color: #005cc5;
            }
            .hljs-meta .hljs-string,
            .hljs-regexp,
            .hljs-string {
                color: #032f62;
            }
            .hljs-built_in,
            .hljs-symbol {
                color: #e36209;
            }
            .hljs-code,
            .hljs-comment,
            .hljs-formula {
                color: #6a737d;
            }
            .hljs-name,
            .hljs-quote,
            .hljs-selector-pseudo,
            .hljs-selector-tag {
                color: #22863a;
            }
            .hljs-subst {
                color: #24292e;
            }
            .hljs-section {
                color: #005cc5;
                font-weight: bold;
            }
            .hljs-bullet {
                color: #735c0f;
            }
            .hljs-emphasis {
                color: #24292e;
                font-style: italic;
            }
            .hljs-strong {
                color: #24292e;
                font-weight: bold;
            }
            .hljs-addition {
                color: #22863a;
                background-color: #f0fff4;
            }
            .hljs-deletion {
                color: #b31d28;
                background-color: #ffeef0;
            }
            .hljs-char.escape_,
            .hljs-link,
            .hljs-params,
            .hljs-property,
            .hljs-punctuation,
            .hljs-tag {
            }
        </style>
    </head>
    <body>
        <div class="content">
            <header class="site-header">
    <a href="/" class="home">Brian Douglas</a>

    <div class="svg-container">
        <a href="https://github.com/BrianDouglasIE" class="github">
            <svg
                height="32"
                aria-hidden="true"
                viewBox="0 0 24 24"
                width="32"
                data-view-component="true"
            >
                <path
                    d="M12.5.75C6.146.75 1 5.896 1 12.25c0 5.089 3.292 9.387 7.863 10.91.575.101.79-.244.79-.546 0-.273-.014-1.178-.014-2.142-2.889.532-3.636-.704-3.866-1.35-.13-.331-.69-1.352-1.18-1.625-.402-.216-.977-.748-.014-.762.906-.014 1.553.834 1.769 1.179 1.035 1.74 2.688 1.25 3.349.948.1-.747.402-1.25.733-1.538-2.559-.287-5.232-1.279-5.232-5.678 0-1.25.445-2.285 1.178-3.09-.115-.288-.517-1.467.115-3.048 0 0 .963-.302 3.163 1.179.92-.259 1.897-.388 2.875-.388.977 0 1.955.13 2.875.388 2.2-1.495 3.162-1.179 3.162-1.179.633 1.581.23 2.76.115 3.048.733.805 1.179 1.825 1.179 3.09 0 4.413-2.688 5.39-5.247 5.678.417.36.776 1.05.776 2.128 0 1.538-.014 2.774-.014 3.162 0 .302.216.662.79.547C20.709 21.637 24 17.324 24 12.25 24 5.896 18.854.75 12.5.75Z"
                ></path>
            </svg>
        </a>

        <a
            href="https://linkedin.com/in/brian-douglas-90abb93ab"
            class="linkedin"
        >
            <svg
                viewBox="0 0 128 128"
                height="32"
                aria-hidden="true"
                width="32"
                data-view-component="true"
            >
                <path
                    d="M116 3H12a8.91 8.91 0 00-9 8.8v104.42a8.91 8.91 0 009 8.78h104a8.93 8.93 0 009-8.81V11.77A8.93 8.93 0 00116 3zM39.17 107H21.06V48.73h18.11zm-9-66.21a10.5 10.5 0 1110.49-10.5 10.5 10.5 0 01-10.54 10.48zM107 107H88.89V78.65c0-6.75-.12-15.44-9.41-15.44s-10.87 7.36-10.87 15V107H50.53V48.73h17.36v8h.24c2.42-4.58 8.32-9.41 17.13-9.41C103.6 47.28 107 59.35 107 75z"
                ></path>
            </svg>
        </a>
    </div>
</header>

            <div class="breadcrumbs">
                <a href="/">Home</a> / <span>Use an index when sorting</span>
            </div>

            <main>
                <article class="post">
                    <header>
                        <h1>Use an index when sorting</h1>
                        <time datetime="26/02/2026"
                            >February 26th, 2026</time
                        >
                    </header>

                    <div class="body"><p>When working with a database it is a very common task to retrieve a sorted
list of entities. What you might not realize is that this can be a very 
expensive operation.</p>
<!-- more -->
<p>If an index is not present on the table which the select is being used on
a filesort may be performed. This is what happens in the example below using
MariaDB. When performing a file sort, the database fetches every row and sorts
each in memory before performing a query, which in this case is selecting the
first 10 results.</p>
<p>Applying an index on the column you wish to sort by (<code>ORDER BY</code>) means that the
database can skip the sort altogether. Instead of the previous scenario of
fetching all rows and then sorting them, the index will allow it to just grab the
first 10 entries.</p>
<h2 id="thetopnquery">The Top-N query</h2>
<p><magpie-trinket>He hasn't just made up the term <em>Top-N query</em> here is a reference and explantation from <a href="https://nightlies.apache.org/flink/flink-docs-master/docs/sql/reference/queries/topn/#:~:text=Top%2DN%20queries%20are%20useful,express%20a%20Top%2DN%20query.">Apache Flink</a>.</magpie-trinket></p>
<p>A Top-N query is where you want to get the first N or last N results of table. It's
a super common query to perform. But as we explained above, it can be very slow if used
without an index.</p>
<p>I'll be using the schema displayed below for each of the sql snippets in this post.
The schema represents an example database that can be found on the
<a href="https://www.mariadbtutorial.com/getting-started/mariadb-sample-database/">mariadbtutorial.com</a>
website.</p>
<p><img src="/images/nation-schema.png" alt="nation db schema" /></p>
<p>You'll see from the above schema that each <code>countries</code> entity can have many <code>country_stats</code>
entities. This means there is likely to be a lot of <code>county_stats</code> entities. So let's fetch
the top 10 <code>country_stats</code> by population.</p>
<pre class="sql language-sql"><code class="hljs sql language-sql"><span class="hljs-keyword">SELECT</span> country_id, population
<span class="hljs-keyword">FROM</span> country_stats
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> population <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">10</span>;
</code></pre>
<p>Running the following query with <code>explain</code> tells me that 9514 rows were checked and that
a filesort was performed. This confirms that I wrote above, when there is no index the
database has to search through each row THEN do the sort.</p>
<p>Let's fix this by adding an index on the <code>country_stats</code> table targeting the <code>population</code>
column in descending order.</p>
<pre class="sql language-sql"><code class="hljs sql language-sql"><span class="hljs-keyword">CREATE</span> INDEX idx_population_desc <span class="hljs-keyword">ON</span> country_stats (population <span class="hljs-keyword">DESC</span>);
</code></pre>
<p>Now when the original query is run, <code>explain</code> tells me that only 10 records were checked
and that the <code>idx_population_desc</code> index was used.</p>
<table>
    <thead>
        <tr>
            <th>Method</th>
            <th>Rows Checked</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Using filesort</td>
            <td>9514</td>
        </tr>
        <tr>
            <td>Using index</td>
            <td>10</td>
        </tr>
    </tbody>
</table>
<p>So when doing a Top-N query make sure to add an index on the column and specify the order
you wish to sort by.</p></div>

                    <footer>
                        <p><i>Until next time,</i></p>
                        <p><i>Brian</i></p>
                    </footer>
                </article>
            </main>

            <footer class="site-footer">
    <p>
        <small>Since August 4th, 2023. All words by Brian
            Douglas. <a href="mailto:brianwdouglas@proton.me">Have a comment?</a></small>
    </p>
</footer>

        </div>

        <script src="/scripts/chicken-and-magpie.js"></script>
        <script src="/scripts/skip-to-section.js"></script>
    </body>
</html>
