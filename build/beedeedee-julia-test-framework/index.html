<!doctype html>
<html lang="en">
    <head>
        <!-- Google tag (gtag.js) -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-SXTREFVFLB"
        ></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());

            gtag("config", "G-SXTREFVFLB");
        </script>

        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- Meta Description -->
        <meta name="description" content="I wrote a test framework in Julia" />

        <!-- Keywords -->
        <meta
            name="keywords"
            content="Brian Douglas, blog, julia"
        />

        <!-- Author -->
        <meta name="author" content="Brian Douglas" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta
            property="og:title"
            content="BrianDouglas.ie - I wrote a test framework in Julia"
        />
        <meta property="og:description" content="I wrote a test framework in Julia" />
        <meta property="og:url" content="https://www.briandouglas.ie" />
        <meta
            property="og:image"
            content="http://www.briandouglas.ie/images/og-images/beedeedee-julia-test-framework.png"
        />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="1280" />
        <meta property="og:image:height" content="640" />
        <meta property="og:site_name" content="BrianDouglas.ie" />
        <meta
            property="og:image:alt"
            content="A preview image for the post titled 'I wrote a test framework in Julia'"
        />

        <!-- Twitter Meta -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@BrianDouglasIE" />
        <meta
            name="twitter:title"
            content="BrianDouglas.ie - I wrote a test framework in Julia"
        />
        <meta name="twitter:description" content="I wrote a test framework in Julia" />
        <meta
            name="twitter:image"
            content="http://www.briandouglas.ie/images/og-images/beedeedee-julia-test-framework.png"
        />

        <!-- Canonical URL -->
        <link rel="canonical" href="https://www.briandouglas.ie" />

        <!-- Favicon (Optional) -->
        <link
            rel="icon"
            href="https://www.briandouglas.ie/favicon.ico"
            type="image/x-icon"
        />

        <!-- Robots -->
        <meta name="robots" content="index, follow" />

        <!-- Favicon-->
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="/favicon-16x16.png"
        />
        <link rel="manifest" href="/site.webmanifest" />

        <title>I wrote a test framework in Julia</title>
        <link rel="stylesheet" href="/styles.css" />
        <style>
            pre code.hljs {
                display: block;
                overflow-x: auto;
                padding: 1em;
            }
            code.hljs {
                padding: 3px 5px;
            }
            .hljs {
                color: #24292e;
                background: #ffffff;
            }
            .hljs-doctag,
            .hljs-keyword,
            .hljs-meta .hljs-keyword,
            .hljs-template-tag,
            .hljs-template-variable,
            .hljs-type,
            .hljs-variable.language_ {
                color: #d73a49;
            }
            .hljs-title,
            .hljs-title.class_,
            .hljs-title.class_.inherited__,
            .hljs-title.function_ {
                color: #6f42c1;
            }
            .hljs-attr,
            .hljs-attribute,
            .hljs-literal,
            .hljs-meta,
            .hljs-number,
            .hljs-operator,
            .hljs-selector-attr,
            .hljs-selector-class,
            .hljs-selector-id,
            .hljs-variable {
                color: #005cc5;
            }
            .hljs-meta .hljs-string,
            .hljs-regexp,
            .hljs-string {
                color: #032f62;
            }
            .hljs-built_in,
            .hljs-symbol {
                color: #e36209;
            }
            .hljs-code,
            .hljs-comment,
            .hljs-formula {
                color: #6a737d;
            }
            .hljs-name,
            .hljs-quote,
            .hljs-selector-pseudo,
            .hljs-selector-tag {
                color: #22863a;
            }
            .hljs-subst {
                color: #24292e;
            }
            .hljs-section {
                color: #005cc5;
                font-weight: bold;
            }
            .hljs-bullet {
                color: #735c0f;
            }
            .hljs-emphasis {
                color: #24292e;
                font-style: italic;
            }
            .hljs-strong {
                color: #24292e;
                font-weight: bold;
            }
            .hljs-addition {
                color: #22863a;
                background-color: #f0fff4;
            }
            .hljs-deletion {
                color: #b31d28;
                background-color: #ffeef0;
            }
            .hljs-char.escape_,
            .hljs-link,
            .hljs-params,
            .hljs-property,
            .hljs-punctuation,
            .hljs-tag {
            }
        </style>
    </head>
    <body>
        <div class="content">
            <header class="site-header">
    <a href="/" class="home">Brian Douglas</a>

    <div class="svg-container">
        <a href="https://github.com/BrianDouglasIE" class="github">
            <svg
                height="32"
                aria-hidden="true"
                viewBox="0 0 24 24"
                width="32"
                data-view-component="true"
            >
                <path
                    d="M12.5.75C6.146.75 1 5.896 1 12.25c0 5.089 3.292 9.387 7.863 10.91.575.101.79-.244.79-.546 0-.273-.014-1.178-.014-2.142-2.889.532-3.636-.704-3.866-1.35-.13-.331-.69-1.352-1.18-1.625-.402-.216-.977-.748-.014-.762.906-.014 1.553.834 1.769 1.179 1.035 1.74 2.688 1.25 3.349.948.1-.747.402-1.25.733-1.538-2.559-.287-5.232-1.279-5.232-5.678 0-1.25.445-2.285 1.178-3.09-.115-.288-.517-1.467.115-3.048 0 0 .963-.302 3.163 1.179.92-.259 1.897-.388 2.875-.388.977 0 1.955.13 2.875.388 2.2-1.495 3.162-1.179 3.162-1.179.633 1.581.23 2.76.115 3.048.733.805 1.179 1.825 1.179 3.09 0 4.413-2.688 5.39-5.247 5.678.417.36.776 1.05.776 2.128 0 1.538-.014 2.774-.014 3.162 0 .302.216.662.79.547C20.709 21.637 24 17.324 24 12.25 24 5.896 18.854.75 12.5.75Z"
                ></path>
            </svg>
        </a>

        <a
            href="https://linkedin.com/in/brian-douglas-90abb93ab"
            class="linkedin"
        >
            <svg
                viewBox="0 0 128 128"
                height="32"
                aria-hidden="true"
                width="32"
                data-view-component="true"
            >
                <path
                    d="M116 3H12a8.91 8.91 0 00-9 8.8v104.42a8.91 8.91 0 009 8.78h104a8.93 8.93 0 009-8.81V11.77A8.93 8.93 0 00116 3zM39.17 107H21.06V48.73h18.11zm-9-66.21a10.5 10.5 0 1110.49-10.5 10.5 10.5 0 01-10.54 10.48zM107 107H88.89V78.65c0-6.75-.12-15.44-9.41-15.44s-10.87 7.36-10.87 15V107H50.53V48.73h17.36v8h.24c2.42-4.58 8.32-9.41 17.13-9.41C103.6 47.28 107 59.35 107 75z"
                ></path>
            </svg>
        </a>
    </div>
</header>

            <div class="breadcrumbs">
                <a href="/">Home</a> / <span>I wrote a test framework in Julia</span>
            </div>

            <main>
                <article class="post">
                    <header>
                        <h1>I wrote a test framework in Julia</h1>
                        <time datetime="21/10/2024"
                            >October 21st, 2024</time
                        >
                    </header>

                    <div class="body"><p>I didn't set out to write a test framework in Julia. But I ended up
going down the rabbit hole, and learning a lot about the language
on the way.</p>
<!-- more -->
<p><chicken-asks>
Hold up! He wrote a test framework in Julia?
</chicken-asks></p>
<p><magpie-replies>
Yea, he must think he's a polyglot or something.
</magpie-replies></p>
<h2 id="whyjulia">Why Julia?</h2>
<p>Well that is a straight forward one to answer. I was watching a Formula 1
race and noticed that JuliaHub is a sponsor of the Williams F1 team. So
naturally I thought I better try out the language and so I set about writing
some programs in Julia.</p>
<p>Julia is mainly used in the academic and scientific realms. But at it's core
it is quite a nice general purpose language.</p>
<p>It is similar to Python, but it does not support OOP. Instead it uses pattern
matching with method overloads to handle different data types. For example let's
say we have a greeter function that can greet students and teachers. In Julia
that might look like this.</p>
<pre class="julia language-julia"><code class="hljs julia language-julia"><span class="hljs-keyword">function</span> greet(person::Teacher)
  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello Teacher&quot;</span>
<span class="hljs-keyword">end</span>

<span class="hljs-keyword">function</span> greet(person::Student)
  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello Student&quot;</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>The correct variant of greet get's called based on the type of <code>struct</code> that is 
passed to the method. A <code>struct</code> being the way to define a custom data type.
This takes a little bit of getting used to. But once I got my head around the fact
that Julia operators were methods it started to make sense. This clicked when
it came to writing comparators for <a href="https://github.com/BrianDouglasIE/BeeDeeDee.jl/tree/main">BeeDeeDee.jl</a> the test framework I ended up writing.</p>
<p>But <strong>why</strong> did I end up writing a test framework? I hear you ask. Well because the built
in Julia test framework lacked features that I wanted and would expect every test 
framework to have. For example hooks, like <code>before_each</code> and <code>after_all</code>, as well
as human readable methods. The latter being something that the Julia community
seem to readily reject. Opting to use mathematic operators where they can. Which
is no surprise when Julia's scientific background is taken into account.</p>
<p>So I set off into the unknown and started writing a test framework. I had a clear
idea in mind of what I wanted to achieve. That being an api that looked like the following.</p>
<pre class="julia language-julia"><code class="hljs julia language-julia">describe(<span class="hljs-string">&quot;User Age Tests&quot;</span>) <span class="hljs-keyword">do</span>
  it(<span class="hljs-string">&quot;should have an age greater than or equal 18 and less than 100&quot;</span>) <span class="hljs-keyword">do</span>
    expect(user.age) |&gt;
      to_be_greater_than_or_equal(<span class="hljs-number">18</span>) |&gt; and |&gt; to_be_less_than(<span class="hljs-number">100</span>)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h2 id="theimplementation">The implementation</h2>
<p>Starting off with the code I wanted to achieve was a great help. I knew that I wanted to
make use of method chaining using Julia's pipe operator <code>|&gt;</code>. The reason for this being
that it allows for clear an readable code. It also allows for a data structure to
be passed through and transformed by multiple methods. This would be necessary for assertions.</p>
<p>In BeeDeeDee the <code>expect</code> method takes a value and creates an <code>Expectation</code> struct based off of
that value. The <em>comparators</em>, which are methods that are called against the assertion, then
take the value of the assertion and apply their own logic. These are essentially methods which
check for the correct <code>boolean</code> value when comparing their own value with the assertion. I say
<em>correct</em> <code>boolean</code> value as an <code>Expectation</code> may be negated using the <code>not</code> comparator. Which 
essentially reverses the expected <code>boolean</code> value from <code>True</code> to <code>False</code>.</p>
<p>The <code>Expectation</code> struct itself holds it's own value as well as it's comparator function and
result of that comparator function, once it has been applied on it's value. This is necessary
as more than one expectation may be called per test. The code for the <code>Expectation</code> struct is
minimal as shown below. You'll notice that a <code>Vector{String}</code> data type is also present. This
is used to store the logs from the Expectation's comparator methods. Which are used for cli
reporting.</p>
<pre class="julia language-julia"><code class="hljs julia language-julia"><span class="hljs-keyword">struct</span> Expectation
    value::<span class="hljs-built_in">Any</span>
    comparator::<span class="hljs-built_in">Function</span>
    result::<span class="hljs-built_in">Bool</span>
    logs::<span class="hljs-built_in">Vector</span>{<span class="hljs-built_in">String</span>}
<span class="hljs-keyword">end</span>
</code></pre>
<p>The test framework allows for tests to be grouped and hooks to be applied to those groups.
Implementing this was difficult and my solution was not ideal. In order to keep track of
what the current test suite was I used a global variable that stored the current test suite's
id. The id belonged to a <code>Suite</code> struct that was created when either <code>testgroup</code> or <code>describe</code> 
was called. This struct would then be used to hold information such as the tests which were
run inside the suite, the results of those tests, as well as the hooks that should be run before
and after each test. The definition of these structs are below.</p>
<pre class="julia language-julia"><code class="hljs julia language-julia">Base.<span class="hljs-meta">@kwdef</span> <span class="hljs-keyword">mutable struct</span> Hooks
    before_all_called::<span class="hljs-built_in">Bool</span> = <span class="hljs-literal">false</span>
    after_all_called::<span class="hljs-built_in">Bool</span> = <span class="hljs-literal">false</span>
    before_all::<span class="hljs-built_in">Vector</span>{<span class="hljs-built_in">Union</span>{<span class="hljs-built_in">Nothing</span>,<span class="hljs-built_in">Function</span>}} = []
    after_all::<span class="hljs-built_in">Vector</span>{<span class="hljs-built_in">Union</span>{<span class="hljs-built_in">Nothing</span>,<span class="hljs-built_in">Function</span>}} = []
    before_each::<span class="hljs-built_in">Vector</span>{<span class="hljs-built_in">Union</span>{<span class="hljs-built_in">Nothing</span>,<span class="hljs-built_in">Function</span>}} = []
    after_each::<span class="hljs-built_in">Vector</span>{<span class="hljs-built_in">Union</span>{<span class="hljs-built_in">Nothing</span>,<span class="hljs-built_in">Function</span>}} = []
<span class="hljs-keyword">end</span>

Base.<span class="hljs-meta">@kwdef</span> <span class="hljs-keyword">mutable struct</span> TestResult
    description::<span class="hljs-built_in">String</span> = <span class="hljs-string">&quot;&quot;</span>
    status::<span class="hljs-built_in">Symbol</span> = :Pending
    f::<span class="hljs-built_in">Union</span>{<span class="hljs-built_in">Task</span>,<span class="hljs-built_in">Function</span>} = () -&gt; <span class="hljs-literal">nothing</span>
    expectations::<span class="hljs-built_in">Vector</span>{Expectation} = []
    stacktrace::<span class="hljs-built_in">Any</span> = []
<span class="hljs-keyword">end</span>

Base.<span class="hljs-meta">@kwdef</span> <span class="hljs-keyword">mutable struct</span> Suite
    tests::<span class="hljs-built_in">Vector</span>{TestResult} = []
    child_suites::<span class="hljs-built_in">Vector</span>{Suite} = []
    f::<span class="hljs-built_in">Union</span>{<span class="hljs-built_in">Task</span>,<span class="hljs-built_in">Function</span>} = () -&gt; <span class="hljs-literal">nothing</span>
    status::<span class="hljs-built_in">Symbol</span> = :Pending
    hooks::Hooks = Hooks()
    description::<span class="hljs-built_in">String</span> = <span class="hljs-string">&quot;&quot;</span>
    id::<span class="hljs-built_in">Int64</span> = <span class="hljs-number">0</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>I mentioned that this was not a <em>good</em> solution. This is because it would not allow for concurrent
test files to be run. Because a global variable is used to store the current suite, the tests
must be executed in order. Otherwise their results could end up in the wrong <code>Suite</code> struct.
I'm still not entirely sure how this could be solved. I would have to take a look at other 
frameworks for some inspiration.</p>
<p>The final noteworthy part of the implementation was the use of Julia's built in operators to create
comparators. I was able to leverage the fact that Julia's builtin operators are methods themselves,
to create concise comparators. For example I wrote a helper method called <code>construct_comparator</code> that
took an operator as an argument and then used it as a callback method to compare the expected value
with the actual value. I have left out the code for <code>construct_comparator</code> as it contains reporting
logic which makes the code hard to understand without some domain knowledge. What is easy to understand
however is it's use. For example here is how the <code>to_be</code> comparator is defined.</p>
<pre class="julia language-julia"><code class="hljs julia language-julia">to_be = construct_comparator(===, <span class="hljs-string">&quot;to be&quot;</span>)
</code></pre>
<p><magpie-trinket>
Why not look through the source code of BeeDeeDee.jl yourself. It's a small codebase which can be view at
<a href="https://github.com/BrianDouglasIE/BeeDeeDee.jl/tree/main">BrianDouglasIE/BeeDeeDee.jl</a>
</magpie-trinket></p>
<h2 id="mythoughtsonjulia">My thoughts on Julia</h2>
<p>Writing a test framework in an unknown programming language is quite a feat. But it allowed me to
really dig down deep into Julia in quite a short period of time. I was impressed by the syntax of
Julia. There are some real opportunities to write beautiful code. The use of the <code>do</code> keyword and
pipe operator allow for concise and readable code. Even if it took me a while to understand the
argument order required for the <code>do</code> keyword.</p>
<p>It's a shame however that the <em>beautiful</em> and readable syntax which Julia can offer is contrasted 
with some awkward syntax such as how default arguments are assigned in a struct. For example, the 
<code>Suite</code> struct in BeeDeeDee.jl.</p>
<pre class="julia language-julia"><code class="hljs julia language-julia">Base.<span class="hljs-meta">@kwdef</span> <span class="hljs-keyword">mutable struct</span> Suite
    tests::<span class="hljs-built_in">Vector</span>{TestResult} = []
    child_suites::<span class="hljs-built_in">Vector</span>{Suite} = []
    f::<span class="hljs-built_in">Union</span>{<span class="hljs-built_in">Task</span>,<span class="hljs-built_in">Function</span>} = () -&gt; <span class="hljs-literal">nothing</span>
    status::<span class="hljs-built_in">Symbol</span> = :Pending
    hooks::Hooks = Hooks()
    description::<span class="hljs-built_in">String</span> = <span class="hljs-string">&quot;&quot;</span>
    id::<span class="hljs-built_in">Int64</span> = <span class="hljs-number">0</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>Experienced users of Julia might look past this. But to me it reeks of complexity. To understand this
a developer must understand why the <code>mutable</code> keyword is there, and what <code>Base.@kwdef</code> is, as well
as why a <code>macro</code> is needed. A <code>macro</code> being a language feature that allows for certain meta programming
techniques. They are used frequently, but I've only ever found them to add complexity.</p>
<p>Another example of Julia being awkward is in it's use of <code>modules</code> and <code>exports</code>. I still don't
fully understand how <code>modules</code> work. One might think of them sort of like a <code>class</code> in OOP. They act
like a container for code, which can export certain members. Unfortunately though Julia forces
the developer to export each method individually. Leading to some verbose code. Below is the 
comparators export for BeeDeeDee. A <code>public</code> keyword on the method definition would be much nicer.</p>
<pre class="julia language-julia"><code class="hljs julia language-julia"><span class="hljs-keyword">export</span> to_be,
to_be_true,
to_be_false,
to_be_greater_than,
to_be_less_than,
to_be_greater_than_or_equal,
to_be_less_than_or_equal,
to_be_in,
to_be_nothing,
to_be_typeof,
to_be_empty,
to_have_key,
to_be_subset,
to_be_setequal,
to_be_disjoint,
to_match,
to_be_valid_email,
to_throw
</code></pre>
<p>Imports are equally awkward. Every time a module is imported it is imported fresh. Meaning that
if A.jl and B.jl are in the same application and import C.jl. There will be a conflict and an error
with Julia complaining that C.jl is already imported. To get around this Julia developers import
modules into a common parent and access them using a path like syntax. With <code>using ..C</code> meaning 
import the C.jl module that was required in my parent's scopeâ€¦ yikes.</p>
<h3 id="willjuliabecomeamainstreamlanguage">Will Julia become a mainstream language?</h3>
<p>In data science and academia, yes. Maybe third or fourth for popularity at it's height. But only 
because there seems to be a lot of money behind it. Well at least I assume there must be if 
Formula 1 cars are being sponsored by JuliaHub.</p>
<p>In anything else, no. I was not convinced that Julia would help me solve any problems on the web or
in game dev. It did introduce me to some novel concepts. But ultimately there was nothing there to
convert me into a Julia developer. The main annoyances being around how modules work. I could never
imagine building a large complicated system in a language that has such confusing code interop.</p></div>

                    <footer>
                        <p><i>Until next time,</i></p>
                        <p><i>Brian</i></p>
                    </footer>
                </article>
            </main>

            <footer class="site-footer">
    <p>
        <small>Since August 4th, 2023. All words by Brian
            Douglas. <a href="mailto:brianwdouglas@proton.me">Have a comment?</a></small>
    </p>
</footer>

        </div>

        <script src="/scripts/chicken-and-magpie.js"></script>
        <script src="/scripts/skip-to-section.js"></script>
    </body>
</html>
